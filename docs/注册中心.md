### Install consul

consul是google开源的一个使用go语言开发的服务发现、配置管理中心服务。内置了服务注册与发现框 架、分布一致性协议实现、健康检查、Key/Value存储、多数据中心方案。

```shell
sudo mkdir /etc/consul.d/ /data/consul -p
sudo touch /etc/consul.d/docker-compose.yaml
sudo chmod -R 777 /data/consul /etc/consul.d
sudo cat > /etc/consul.d/docker-compose.yaml <<EOF
version: "3.5"
services:
  consul1:
    container_name: consul1
    image: consul:1.8.5
    command: agent -server -config-dir /etc/consul.d/ -node=server-1 -data-dir=/data/consul/server-1 -log-file=/data/consul/server-1/log/ -bootstrap-expect=3
    volumes:
     - /etc/consul.d/:/etc/consul.d/
     - /data/consul/server-1/:/data/consul/server-1/
    networks:
      - consul
    ports:
      - 8300
      - 8500
    restart: always
  consul2:
    container_name: consul2
    image: consul:1.8.5
    command: agent -server -config-dir /etc/consul.d/ -node=server-2 -data-dir=/data/consul/server-2 -log-file=/data/consul/server-2/log/ -join=consul1
    volumes:
     - /etc/consul.d/:/etc/consul.d/
     - /data/consul/server-2/:/data/consul/server-2/
    networks:
      - consul
    ports:
      - 8300
      - 8500
    restart: always
    depends_on:
      - consul1
  consul3:
    container_name: consul3
    image: consul:1.8.5
    command: agent -server -config-dir /etc/consul.d/ -node=server-3 -data-dir=/data/consul/server-3 -log-file=/data/consul/server-3/log/ -join=consul1
    volumes:
     - /etc/consul.d/:/etc/consul.d/
     - /data/consul/server-3/:/data/consul/server-3/
    networks:
      - consul
    ports:
      - 8300
      - 8500
    restart: always
    depends_on:
      - consul1
  consul4:
    container_name: consul4
    image: consul:1.8.5
    command: agent -ui -config-dir /etc/consul.d/ -node=client-1 -data-dir=/data/consul/client-1 -log-file=/data/consul/client-1/log/ -join=consul1
    volumes:
     - /etc/consul.d/:/etc/consul.d/
     - /data/consul/client-1/:/data/consul/client-1/
    networks:
      - consul
    ports:
      - 8300
      - 8500:8500
    restart: always
    depends_on:
      - consul1
networks:
  consul:
    driver: bridge
EOF
docker-compose -f /etc/consul.d/docker-compose.yaml up -d
```

添加配置
```shell
curl 'http://127.0.0.1:8500/v1/kv/micro/config/comm?dc=dc&flags=0' \
-X 'PUT' \
-H 'Connection: keep-alive' \
-H 'Content-Type: application/json; charset=UTF-8' \
-H 'Accept: */*' \
-H 'Origin: http://127.0.0.1:8500' \
-H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7' \
-H 'Cookie: io=r1hlEUjS4Ox4XtGTAACZ' \
-H 'token: DTFDUAGFPTWWXQOIDQSMUA' \
--data-raw $'{\n    "jwt_white_list": ["/helloworld/handler11"],\n    "jwt_secret": "7y3h237ye2o38sdasd9asduahsda8sdaushd9-a9s9idasdhd",\n    "registry_address":"172.30.13.77:8500",\n    "broker":"nats",\n    "broker_address":"172.30.12.14:4222",\n    "opentracing_address":"127.0.0.1:6831",\n  \u0009"redis_address":"127.0.0.1:6379",\n    "redis_passwd":"gmt692#112"\n}' \
--compressed
```

```shell
curl 'http://127.0.0.1:8500/v1/kv/micro/config/srv/helloworld?dc=dc&flags=0' \
-X 'PUT' \
-H 'Connection: keep-alive' \
-H 'Content-Type: application/json; charset=UTF-8' \
-H 'Accept: */*' \
-H 'Origin: http://127.0.0.1:8500' \
-H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7' \
-H 'Cookie: io=r1hlEUjS4Ox4XtGTAACZ' \
-H 'token: DTFDUAGFPTWWXQOIDQSMUA' \
--data-raw $'{\n"data_source": "root:111111@/dolphin_localhost?charset=utf8&parseTime=True&loc=Local&"\n}' \
--compressed
```